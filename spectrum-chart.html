<!doctype html>
<html>
    <head>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap"
            rel="stylesheet"
        />

        <title>Spectrum Chart</title>
        <style>
            body {
                margin: 0;
                overflow: hidden;
                touch-action: none;
                font-family: "Quicksand", sans-serif;
            }
            * {
                font-family: "Quicksand", sans-serif;
                font-optical-sizing: auto;
                font-weight: 500;
                font-style: normal;
            }
            #canvas {
                touch-action: none;
            }
            .zoom-controls {
                position: fixed;
                top: 20px;
                right: 20px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                z-index: 1000;
            }
            .button {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                border: none;
                background-color: rgba(255, 255, 255, 0.8);
                cursor: pointer;
                font-size: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                transition: background-color 0.2s;
            }
            .button:hover {
                background-color: rgba(255, 255, 255, 0.9);
            }
            .button:active {
                background-color: rgba(255, 255, 255, 1);
                transform: translateY(1px);
                .controls-dropdown {
                    position: fixed;
                    top: 120px;
                    right: 20px;
                    z-index: 1000;
                }
            }

            .dropdown-content {
                display: none;
                position: absolute;
                right: 0;
                background-color: white;
                min-width: 300px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                border-radius: 8px;
                padding: 10px;
            }

            .controls-dropdown:hover .dropdown-content {
                display: block;
            }

            .dropdown-content label {
                display: block;
                padding: 5px;
                cursor: pointer;
            }

            .dropdown-content label:hover {
                background-color: #f0f0f0;
            }

            .dropdown-content hr {
                border: none;
                height: 1px;
                background-color: #ddd;
                margin: 8px 0;
            }

            .dropdown-content h4 {
                margin: 5px 0;
                color: #666;
                font-weight: 700;
                font-size: 12px;
                padding: 0 5px;
            }
        </style>
    </head>
    <body>
        <canvas id="canvas"></canvas>
        <div class="zoom-controls">
            <button class="button" id="zoom-in">+</button>
            <button class="button" id="zoom-minus">−</button>
            <div class="controls-dropdown">
                <button class="button" id="settings">⚙️</button>
                <div class="dropdown-content">
                    <h4>Wi-Fi</h4>
                    <label
                        ><input type="checkbox" id="show-wifi" checked />
                        Wi-Fi</label
                    >
                    <label
                        ><input type="checkbox" id="show-channels" checked />
                        Channel Numbers</label
                    >
                    <label
                        ><input type="checkbox" id="show-frequencies" checked />
                        Center Frequencies</label
                    >
                    <label
                        ><input type="checkbox" id="show-overlapping" /> 2.4 GHz
                        Overlapping Channels</label
                    >
                    <h4>Bluetooth</h4>
                    <label
                        ><input type="checkbox" id="show-bluetooth" checked />
                        Bluetooth</label
                    >
                    <label
                        ><input type="checkbox" id="show-bluetooth-channels" />
                        Channel Numbers</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="show-bluetooth-frequencies"
                        />
                        Center Frequencies</label
                    >
                    <h4>Zigbee</h4>
                    <label
                        ><input type="checkbox" id="show-zigbee" />
                        Zigbee</label
                    >
                    <label
                        ><input type="checkbox" id="show-zigbee-channels" />
                        Channel Numbers</label
                    >
                    <label
                        ><input type="checkbox" id="show-zigbee-frequencies" />
                        Center Frequencies</label
                    >
                    <h4>General</h4>
                    <label>
                        <input type="checkbox" id="show-band-labels" checked />
                        Show Band Labels
                    </label>
                    <label>
                        <input type="checkbox" id="show-subbands" checked />
                        Show Sub-Band Labels
                    </label>
                    <label>
                        <input type="radio" name="domain" value="FCC" checked />
                        FCC
                    </label>
                    <label>
                        <input type="radio" name="domain" value="ETSI" /> ETSI
                    </label>
                    <label>
                        Height:
                        <input
                            type="range"
                            id="height-slider"
                            min="20"
                            max="400"
                            value="100"
                        />
                    </label>
                </div>
            </div>
        </div>
        <script>
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            const heightSlider = document.getElementById("height-slider");

            const minZoom = 0.2;
            const maxZoom = 30;

            // Setting state variables
            let showWifi = true;
            let showWifiChannels = true;
            let showWifiFrequencies = true;
            let showOverlapping = false;
            let showBluetooth = true;
            let showBluetoothChannels = false;
            let showBluetoothFrequencies = false;
            let showZigbee = false;
            let showZigbeeChannels = false;
            let showZigbeeFrequencies = false;
            let showBandLabels = true;
            let showSubbands = true;
            let selectedDomain = "FCC";

            // Other variables
            let offset = { x: 0, y: 0 };
            let scale = 8;
            let isDragging = false;
            let lastPosition = { x: 0, y: 0 };
            let lastPinchDistance = null;
            let isSpacebarDown = false;
            let lockX, lockY;
            let lastScale = scale; // For scale tuning purposes
            const labelPositions = new Map(); // Tracks positions of labels for each x-coordinate

            // Movement variables (incomplete, there are some above)
            let scrollDirection = null;
            let scrollThreshold = 2;
            let lastWheelTime = Date.now();
            const wheelTimeout = 200; // ms to reset direction lock

            // Visual settings
            const chartSettings = {
                channelHeight: 100, // Default signature height
                baselineOffset: 20, // Offsets the text below the baseline
                textSize: 12,
            };

            const LABEL_ROWS = {
                FREQUENCY_MARKERS: 0,
                WIFI_CHANNEL: 1,
                WIFI_FREQ: 2,
                BLUETOOTH_CHANNEL: 3,
                BLUETOOTH_FREQ: 4,
                ZIGBEE_CHANNEL: 5,
                ZIGBEE_FREQ: 6,
            };

            const LABEL_SPACING = 20; // vertical spacing between labels
            const BASE_LABEL_OFFSET = 20; // initial offset from baseline

            // Zoom tiers
            const zoomTiers = {
                lowest: {
                    threshold: 0.25,
                    lineWidth: 0.5,
                    frequency: {
                        step: 1000,
                        minorSteps: 250,
                        showAsGHz: true,
                        ghzDecimals: 0,
                    },
                },
                low: {
                    threshold: 1,
                    lineWidth: 1,
                    frequency: {
                        step: 500,
                        minorSteps: 100,
                        showAsGHz: true,
                        ghzDecimals: 1,
                    },
                },
                medium: {
                    threshold: 2,
                    lineWidth: 1,
                    frequency: {
                        step: 100,
                        minorSteps: 50,
                        showAsGHz: true,
                        ghzDecimals: 1,
                    },
                },
                high: {
                    threshold: 10,
                    lineWidth: 2,
                    frequency: {
                        step: 20,
                        minorSteps: 10,
                        showAsGHz: false,
                        ghzDecimals: 2,
                    },
                },
                highest: {
                    threshold: 20,
                    lineWidth: 3,
                    frequency: {
                        step: 10,
                        minorSteps: 1,
                        showAsGHz: false,
                        ghzDecimals: 3,
                    },
                },
                infinity: {
                    threshold: Infinity,
                    lineWidth: 3,
                    frequency: {
                        step: 2,
                        minorSteps: 1,
                        showAsGHz: false,
                        ghzDecimals: 0,
                    },
                },
            };

            const bands = [
                { name: "900 MHz", start: 902, stop: 928 },
                { name: "CBRS", start: 3550, stop: 3700 },
                { name: "2.4 GHz", start: 2400, stop: 2500 },
                { name: "5 GHz", start: 5170, stop: 5835 },
                { name: "6 GHz", start: 5925, stop: 7125 },
            ];

            const subBands = [
                { domain: "FCC", name: "UNII-1", start: 5150, stop: 5250 },
                { domain: "FCC", name: "UNII-2", start: 5250, stop: 5350 },
                { domain: "FCC", name: "UNII-2e", start: 5470, stop: 5725 },
                { domain: "FCC", name: "UNII-3", start: 5725, stop: 5850 },
                { domain: "FCC", name: "UNII-4", start: 5850, stop: 5925 },
                { domain: "ETSI", name: "Band A", start: 5150, stop: 5350 },
                { domain: "ETSI", name: "Band B", start: 5470, stop: 5725 },
                { domain: "ETSI", name: "Band C", start: 5725, stop: 5875 },
            ];

            const zigbeeChannels = {
                "2.4 GHz": [
                    { channel: 11, frequency: 2405, width: 2 },
                    { channel: 12, frequency: 2410, width: 2 },
                    { channel: 13, frequency: 2415, width: 2 },
                    { channel: 14, frequency: 2420, width: 2 },
                    { channel: 15, frequency: 2425, width: 2 },
                    { channel: 16, frequency: 2430, width: 2 },
                    { channel: 17, frequency: 2435, width: 2 },
                    { channel: 18, frequency: 2440, width: 2 },
                    { channel: 19, frequency: 2445, width: 2 },
                    { channel: 20, frequency: 2450, width: 2 },
                    { channel: 21, frequency: 2455, width: 2 },
                    { channel: 22, frequency: 2460, width: 2 },
                    { channel: 23, frequency: 2465, width: 2 },
                    { channel: 24, frequency: 2470, width: 2 },
                    { channel: 25, frequency: 2475, width: 2 },
                    { channel: 26, frequency: 2480, width: 2 },
                ],
            };

            const bluetoothChannels = {
                "2.4 GHz": [
                    { channel: 0, frequency: 2402, width: 2 },
                    { channel: 1, frequency: 2404, width: 2 },
                    { channel: 2, frequency: 2406, width: 2 },
                    { channel: 3, frequency: 2408, width: 2 },
                    { channel: 4, frequency: 2410, width: 2 },
                    { channel: 5, frequency: 2412, width: 2 },
                    { channel: 6, frequency: 2414, width: 2 },
                    { channel: 7, frequency: 2416, width: 2 },
                    { channel: 8, frequency: 2418, width: 2 },
                    { channel: 9, frequency: 2420, width: 2 },
                    { channel: 10, frequency: 2422, width: 2 },
                    { channel: 11, frequency: 2424, width: 2 },
                    { channel: 12, frequency: 2426, width: 2 },
                    { channel: 13, frequency: 2428, width: 2 },
                    { channel: 14, frequency: 2430, width: 2 },
                    { channel: 15, frequency: 2432, width: 2 },
                    { channel: 16, frequency: 2434, width: 2 },
                    { channel: 17, frequency: 2436, width: 2 },
                    { channel: 18, frequency: 2438, width: 2 },
                    { channel: 19, frequency: 2440, width: 2 },
                    { channel: 20, frequency: 2442, width: 2 },
                    { channel: 21, frequency: 2444, width: 2 },
                    { channel: 22, frequency: 2446, width: 2 },
                    { channel: 23, frequency: 2448, width: 2 },
                    { channel: 24, frequency: 2450, width: 2 },
                    { channel: 25, frequency: 2452, width: 2 },
                    { channel: 26, frequency: 2454, width: 2 },
                    { channel: 27, frequency: 2456, width: 2 },
                    { channel: 28, frequency: 2458, width: 2 },
                    { channel: 29, frequency: 2460, width: 2 },
                    { channel: 30, frequency: 2462, width: 2 },
                    { channel: 31, frequency: 2464, width: 2 },
                    { channel: 32, frequency: 2466, width: 2 },
                    { channel: 33, frequency: 2468, width: 2 },
                    { channel: 34, frequency: 2470, width: 2 },
                    { channel: 35, frequency: 2472, width: 2 },
                    { channel: 36, frequency: 2474, width: 2 },
                    { channel: 37, frequency: 2476, width: 2 },
                    { channel: 38, frequency: 2478, width: 2 },
                    { channel: 39, frequency: 2480, width: 2 },
                ],
            };

            const wifiChannels = {
                "900 MHz": [
                    { channel: 1, frequency: 905, width: 4 },
                    { channel: 2, frequency: 909, width: 4 },
                    { channel: 3, frequency: 913, width: 4 },
                    { channel: 4, frequency: 917, width: 4 },
                    { channel: 5, frequency: 921, width: 4 },
                    { channel: 6, frequency: 925, width: 4 },
                ],
                "2.4 GHz": [
                    { channel: 1, frequency: 2412, width: 20 },
                    {
                        channel: 2,
                        frequency: 2417,
                        width: 20,
                        overlapping: true,
                    },
                    {
                        channel: 3,
                        frequency: 2422,
                        width: 20,
                        overlapping: true,
                    },
                    {
                        channel: 4,
                        frequency: 2427,
                        width: 20,
                        overlapping: true,
                    },
                    {
                        channel: 5,
                        frequency: 2432,
                        width: 20,
                        overlapping: true,
                    },
                    { channel: 6, frequency: 2437, width: 20 },
                    {
                        channel: 7,
                        frequency: 2442,
                        width: 20,
                        overlapping: true,
                    },
                    {
                        channel: 8,
                        frequency: 2447,
                        width: 20,
                        overlapping: true,
                    },
                    {
                        channel: 9,
                        frequency: 2452,
                        width: 20,
                        overlapping: true,
                    },
                    {
                        channel: 10,
                        frequency: 2457,
                        width: 20,
                        overlapping: true,
                    },
                    { channel: 11, frequency: 2462, width: 20 },
                ],
                "5 GHz": [
                    { channel: 36, frequency: 5180, width: 20 },
                    { channel: 40, frequency: 5200, width: 20 },
                    { channel: 44, frequency: 5220, width: 20 },
                    { channel: 48, frequency: 5240, width: 20 },
                    { channel: 52, frequency: 5260, width: 20 },
                    { channel: 56, frequency: 5280, width: 20 },
                    { channel: 60, frequency: 5300, width: 20 },
                    { channel: 64, frequency: 5320, width: 20 },
                    { channel: 100, frequency: 5500, width: 20 },
                    { channel: 104, frequency: 5520, width: 20 },
                    { channel: 108, frequency: 5540, width: 20 },
                    { channel: 112, frequency: 5560, width: 20 },
                    { channel: 116, frequency: 5580, width: 20 },
                    { channel: 120, frequency: 5600, width: 20 },
                    { channel: 124, frequency: 5620, width: 20 },
                    { channel: 128, frequency: 5640, width: 20 },
                    { channel: 132, frequency: 5660, width: 20 },
                    { channel: 136, frequency: 5680, width: 20 },
                    { channel: 140, frequency: 5700, width: 20 },
                    { channel: 144, frequency: 5720, width: 20 },
                    { channel: 149, frequency: 5745, width: 20 },
                    { channel: 153, frequency: 5765, width: 20 },
                    { channel: 157, frequency: 5785, width: 20 },
                    { channel: 161, frequency: 5805, width: 20 },
                    { channel: 165, frequency: 5825, width: 20 },
                ],
                "6 GHz": [
                    { channel: "1E", frequency: 5955, width: 20 },
                    { channel: "5E", frequency: 5975, width: 20 },
                    { channel: "9E", frequency: 5995, width: 20 },
                    { channel: "13E", frequency: 6015, width: 20 },
                    { channel: "17E", frequency: 6035, width: 20 },
                    { channel: "21E", frequency: 6055, width: 20 },
                    { channel: "25E", frequency: 6075, width: 20 },
                    { channel: "29E", frequency: 6095, width: 20 },
                    { channel: "33E", frequency: 6115, width: 20 },
                    { channel: "37E", frequency: 6135, width: 20 },
                    { channel: "41E", frequency: 6155, width: 20 },
                    { channel: "45E", frequency: 6175, width: 20 },
                    { channel: "49E", frequency: 6195, width: 20 },
                    { channel: "53E", frequency: 6215, width: 20 },
                    { channel: "57E", frequency: 6235, width: 20 },
                    { channel: "61E", frequency: 6255, width: 20 },
                    { channel: "65E", frequency: 6275, width: 20 },
                    { channel: "69E", frequency: 6295, width: 20 },
                    { channel: "73E", frequency: 6315, width: 20 },
                    { channel: "77E", frequency: 6335, width: 20 },
                    { channel: "81E", frequency: 6355, width: 20 },
                    { channel: "85E", frequency: 6375, width: 20 },
                    { channel: "89E", frequency: 6395, width: 20 },
                    { channel: "93E", frequency: 6415, width: 20 },
                    { channel: "97E", frequency: 6435, width: 20 },
                    { channel: "101E", frequency: 6455, width: 20 },
                    { channel: "105E", frequency: 6475, width: 20 },
                    { channel: "109E", frequency: 6495, width: 20 },
                    { channel: "113E", frequency: 6515, width: 20 },
                    { channel: "117E", frequency: 6535, width: 20 },
                    { channel: "121E", frequency: 6555, width: 20 },
                    { channel: "125E", frequency: 6575, width: 20 },
                    { channel: "129E", frequency: 6595, width: 20 },
                    { channel: "133E", frequency: 6615, width: 20 },
                    { channel: "137E", frequency: 6635, width: 20 },
                    { channel: "141E", frequency: 6655, width: 20 },
                    { channel: "145E", frequency: 6675, width: 20 },
                    { channel: "149E", frequency: 6695, width: 20 },
                    { channel: "153E", frequency: 6715, width: 20 },
                    { channel: "157E", frequency: 6735, width: 20 },
                    { channel: "161E", frequency: 6755, width: 20 },
                    { channel: "165E", frequency: 6775, width: 20 },
                    { channel: "169E", frequency: 6795, width: 20 },
                    { channel: "173E", frequency: 6815, width: 20 },
                    { channel: "177E", frequency: 6835, width: 20 },
                    { channel: "181E", frequency: 6855, width: 20 },
                    { channel: "185E", frequency: 6875, width: 20 },
                    { channel: "189E", frequency: 6895, width: 20 },
                    { channel: "193E", frequency: 6915, width: 20 },
                    { channel: "197E", frequency: 6935, width: 20 },
                    { channel: "201E", frequency: 6955, width: 20 },
                    { channel: "205E", frequency: 6975, width: 20 },
                    { channel: "209E", frequency: 6995, width: 20 },
                    { channel: "213E", frequency: 7015, width: 20 },
                    { channel: "217E", frequency: 7035, width: 20 },
                    { channel: "221E", frequency: 7055, width: 20 },
                    { channel: "225E", frequency: 7075, width: 20 },
                    { channel: "229E", frequency: 7095, width: 20 },
                    { channel: "233E", frequency: 7115, width: 20 },
                ],
            };

            // Set canvas size to window size
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resizeCanvas();
            window.addEventListener("resize", resizeCanvas);

            offset.x = canvas.width / 2 - 2450 * 2 * scale; // Centers at 2450 MHz

            // Common drawing utilities
            function getBaselineY() {
                return canvas.height / 2;
            }

            function getZoomTier(scale) {
                return Object.values(zoomTiers).find(
                    (tier) => scale < tier.threshold,
                );
            }

            function drawSignatureBase(centerX, centerY, width, height, style) {
                ctx.strokeStyle = style.color;
                ctx.lineWidth = style.lineWidth || 2;
                ctx.lineCap = "round";
            }

            function drawZigguratSignature(
                centerX,
                centerY,
                width,
                height,
                lineColor,
                fillColor,
            ) {
                const topWidth = width * 0.8;

                // Draw fill first
                ctx.beginPath();
                ctx.moveTo(centerX - width / 2, centerY); // Start at bottom left
                ctx.lineTo(centerX - topWidth / 2, centerY - height); // Up to top left
                ctx.lineTo(centerX + topWidth / 2, centerY - height); // Across top
                ctx.lineTo(centerX + width / 2, centerY); // Down to bottom right
                ctx.fillStyle = fillColor;
                ctx.fill();

                // Draw outline (without bottom line)
                ctx.beginPath();
                ctx.strokeStyle = lineColor;
                // Left side
                ctx.moveTo(centerX - topWidth / 2, centerY - height);
                ctx.lineTo(centerX - width / 2, centerY);
                // Right side
                ctx.moveTo(centerX + topWidth / 2, centerY - height);
                ctx.lineTo(centerX + width / 2, centerY);
                // Top line
                ctx.moveTo(centerX - topWidth / 2, centerY - height);
                ctx.lineTo(centerX + topWidth / 2, centerY - height);
                ctx.stroke();
            }

            function drawParabolaSignature(
                centerX,
                centerY,
                width,
                height,
                lineColor,
                fillColor,
            ) {
                const points = 20;

                // Draw fill first
                ctx.beginPath();
                ctx.moveTo(centerX - width / 2, centerY); // Start at bottom left

                // Draw parabola points
                for (let i = 0; i <= points; i++) {
                    const x = (i / points) * width - width / 2;
                    const y = height * (1 - Math.pow((2 * x) / width, 2));
                    ctx.lineTo(centerX + x, centerY - y);
                }

                ctx.lineTo(centerX + width / 2, centerY); // To bottom right
                ctx.fillStyle = fillColor;
                ctx.fill();

                // Draw outline (without bottom line)
                ctx.beginPath();
                ctx.strokeStyle = lineColor;
                // Draw parabola curve only
                for (let i = 0; i <= points; i++) {
                    const x = (i / points) * width - width / 2;
                    const y = height * (1 - Math.pow((2 * x) / width, 2));
                    if (i === 0) {
                        ctx.moveTo(centerX + x, centerY - y);
                    } else {
                        ctx.lineTo(centerX + x, centerY - y);
                    }
                }
                ctx.stroke();
            }

            function drawChannelLabels(
                centerX,
                centerY,
                channel,
                frequency,
                style,
                technology,
            ) {
                let channelRow, frequencyRow;

                switch (technology) {
                    case "wifi":
                        channelRow = LABEL_ROWS.WIFI_CHANNEL;
                        frequencyRow = LABEL_ROWS.WIFI_FREQ;
                        break;
                    case "bluetooth":
                        channelRow = LABEL_ROWS.BLUETOOTH_CHANNEL;
                        frequencyRow = LABEL_ROWS.BLUETOOTH_FREQ;
                        break;
                    case "zigbee":
                        channelRow = LABEL_ROWS.ZIGBEE_CHANNEL;
                        frequencyRow = LABEL_ROWS.ZIGBEE_FREQ;
                        break;
                }

                // Draw channel number if enabled
                if (
                    (technology === "wifi" && showWifiChannels) ||
                    (technology === "bluetooth" && showBluetoothChannels) ||
                    (technology === "zigbee" && showZigbeeChannels)
                ) {
                    drawLabel(
                        centerX,
                        centerY,
                        `${channel}`,
                        channelRow,
                        style.textColor || style.color,
                    );
                }

                // Draw frequency if enabled
                if (
                    (technology === "wifi" && showWifiFrequencies) ||
                    (technology === "bluetooth" && showBluetoothFrequencies) ||
                    (technology === "zigbee" && showZigbeeFrequencies)
                ) {
                    drawLabel(
                        centerX,
                        centerY,
                        `${frequency}`,
                        frequencyRow,
                        style.textColor || style.color,
                    );
                }
            }

            function drawBandLabels() {
                if (!showBandLabels) return;

                const labelHeight = 32;
                const yPosition =
                    getBaselineY() -
                    chartSettings.channelHeight -
                    labelHeight -
                    10;

                ctx.font = "14px Quicksand";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";

                bands.forEach((band) => {
                    const startX = mhzToScreenX(band.start);
                    const stopX = mhzToScreenX(band.stop);
                    const width = stopX - startX;
                    const centerX = startX + width / 2;

                    // Draw rectangle with rounded corners
                    ctx.beginPath();
                    ctx.roundRect(startX, yPosition, width, labelHeight, 6);
                    ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
                    ctx.fill();

                    // Draw text
                    ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
                    ctx.fillText(
                        band.name,
                        centerX,
                        yPosition + labelHeight / 2,
                    );
                });
            }

            function drawSubbandLabels() {
                if (!showSubbands) return;

                const labelHeight = 32;
                const yPosition =
                    getBaselineY() -
                    chartSettings.channelHeight -
                    labelHeight * 2 -
                    20; // Position above band labels

                ctx.font = "14px Quicksand";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";

                // Filter sub-bands for selected domain
                const relevantSubBands = subBands.filter(
                    (band) => band.domain === selectedDomain,
                );

                relevantSubBands.forEach((band) => {
                    const startX = mhzToScreenX(band.start);
                    const stopX = mhzToScreenX(band.stop);
                    const width = stopX - startX;
                    const centerX = startX + width / 2;

                    // Draw rectangle with rounded corners
                    ctx.beginPath();
                    ctx.roundRect(startX, yPosition, width, labelHeight, 6);
                    ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
                    ctx.fill();

                    // Draw text
                    ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
                    ctx.fillText(
                        band.name,
                        centerX,
                        yPosition + labelHeight / 2,
                    );
                });
            }

            function drawFrequencyMarkers(
                ctx,
                scale,
                viewportStart,
                viewportEnd,
            ) {
                const tier = getZoomTier(scale);
                const config = tier.frequency;
                const baselineY = getBaselineY();

                viewportStart = Math.max(0, Math.min(8000, viewportStart));
                viewportEnd = Math.max(0, Math.min(8000, viewportEnd));

                const startFreq =
                    Math.floor(viewportStart / config.step) * config.step;
                const endFreq =
                    Math.ceil(viewportEnd / config.step) * config.step;

                ctx.beginPath();
                ctx.strokeStyle = "#666666";
                ctx.fillStyle = "#666666";
                ctx.textAlign = "center";

                for (
                    let freq = startFreq;
                    freq <= endFreq;
                    freq += config.step
                ) {
                    if (freq >= 0 && freq <= 8000) {
                        const x = mhzToScreenX(freq);

                        // Draw tick mark
                        ctx.moveTo(x, baselineY);
                        ctx.lineTo(x, baselineY + 10);

                        // Draw frequency label using the label system
                        const label = config.showAsGHz
                            ? `${(freq / 1000).toFixed(config.ghzDecimals)} GHz`
                            : `${freq} MHz`;

                        drawLabel(
                            x,
                            baselineY,
                            label,
                            LABEL_ROWS.FREQUENCY_MARKERS,
                            "#666666",
                        );

                        // Draw minor ticks
                        for (
                            let minorFreq = freq + config.minorSteps;
                            minorFreq < freq + config.step && minorFreq <= 8000;
                            minorFreq += config.minorSteps
                        ) {
                            if (minorFreq >= 0) {
                                const minorX = mhzToScreenX(minorFreq);
                                ctx.moveTo(minorX, baselineY);
                                ctx.lineTo(minorX, baselineY + 5);
                            }
                        }
                    }
                }
                ctx.stroke();
            }

            function drawWiFiChannel(channel, scale) {
                const centerX = mhzToScreenX(channel.frequency);
                const centerY = getBaselineY();
                const width = channel.width * 2 * scale;
                const height = chartSettings.channelHeight;
                const style = {
                    lineColor: "#F5D809",
                    fillColor: "rgba(245, 216, 9, 0.2)",
                    lineWidth: getZoomTier(scale).lineWidth,
                    textColor: "black",
                };

                drawSignatureBase(centerX, centerY, width, height, style);
                drawZigguratSignature(
                    centerX,
                    centerY,
                    width,
                    height,
                    style.lineColor,
                    style.fillColor,
                );
                drawChannelLabels(
                    centerX,
                    centerY,
                    channel.channel,
                    channel.frequency,
                    style,
                    "wifi",
                );
            }

            function drawBluetoothChannel(channel, scale) {
                const centerX = mhzToScreenX(channel.frequency);
                const centerY = getBaselineY();
                const width = channel.width * 2 * scale;
                const height = chartSettings.channelHeight;
                const style = {
                    lineColor: "#1486FC",
                    fillColor: "rgba(20, 134, 252, 0.2)", // Semi-transparent blue
                    lineWidth: getZoomTier(scale).lineWidth,
                    textColor: "#1486FC",
                };

                drawSignatureBase(centerX, centerY, width, height, style);
                drawParabolaSignature(
                    centerX,
                    centerY,
                    width,
                    height,
                    style.lineColor,
                    style.fillColor,
                );
                drawChannelLabels(
                    centerX,
                    centerY,
                    channel.channel,
                    channel.frequency,
                    style,
                    "bluetooth",
                );
            }

            function drawZigbeeChannel(channel, scale) {
                const centerX = mhzToScreenX(channel.frequency);
                const centerY = getBaselineY();
                const width = channel.width * 2 * scale;
                const height = chartSettings.channelHeight;
                const style = {
                    lineColor: "#EF3453",
                    fillColor: "rgba(239, 52, 83, 0.2)", // Semi-transparent red
                    lineWidth: getZoomTier(scale).lineWidth,
                    textColor: "#EF3453",
                };

                drawSignatureBase(centerX, centerY, width, height, style);
                drawParabolaSignature(
                    centerX,
                    centerY,
                    width,
                    height,
                    style.lineColor,
                    style.fillColor,
                );
                drawChannelLabels(
                    centerX,
                    centerY,
                    channel.channel,
                    channel.frequency,
                    style,
                    "zigbee",
                );
            }

            function draw() {
                // Clear the canvas and label positions
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                labelPositions.clear(); // Add this line

                // Draw WiFi channels
                if (showWifi) {
                    ["900 MHz", "2.4 GHz", "5 GHz", "6 GHz"].forEach((band) => {
                        wifiChannels[band].forEach((channel) => {
                            if (
                                !(
                                    band === "2.4 GHz" &&
                                    channel.overlapping &&
                                    !showOverlapping
                                )
                            ) {
                                drawWiFiChannel(channel, scale);
                            }
                        });
                    });
                }

                // Draw Bluetooth channels
                if (showBluetooth) {
                    bluetoothChannels["2.4 GHz"].forEach((channel) => {
                        drawBluetoothChannel(channel, scale);
                    });
                }

                // Draw Zigbee channels
                if (showZigbee) {
                    zigbeeChannels["2.4 GHz"].forEach((channel) => {
                        drawZigbeeChannel(channel, scale);
                    });
                }

                // Draw baseline
                const baselineY = getBaselineY();
                ctx.beginPath();
                const startX = mhzToScreenX(0);
                const endX = mhzToScreenX(8000);
                ctx.moveTo(startX, baselineY);
                ctx.lineTo(endX, baselineY);
                ctx.strokeStyle = "black";
                ctx.lineWidth = 2;
                ctx.stroke();

                // Draw frequency markers
                drawFrequencyMarkers(
                    ctx,
                    scale,
                    screenXToMhz(0),
                    screenXToMhz(canvas.width),
                );

                // Draw band labels
                drawBandLabels();
                drawSubbandLabels();

                requestAnimationFrame(draw);
            }

            // Mouse events for panning
            canvas.addEventListener("mousedown", (e) => {
                isDragging = true;
                lastPosition = { x: e.clientX, y: e.clientY };
            });

            canvas.addEventListener("mousemove", (e) => {
                if (isDragging) {
                    offset.x += e.clientX - lastPosition.x;
                    lastPosition.x = e.clientX;
                }
            });

            canvas.addEventListener("mouseup", () => {
                isDragging = false;
            });

            canvas.addEventListener("mouseleave", () => {
                isDragging = false;
            });

            // Touch events for panning and pinch zooming
            canvas.addEventListener("touchstart", (e) => {
                if (e.touches.length === 1) {
                    isDragging = true;
                    lastPosition = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY,
                    };
                }
            });

            canvas.addEventListener("touchmove", (e) => {
                if (e.touches.length === 2) {
                    // Handle pinch zooming
                    const touch1 = e.touches[0];
                    const touch2 = e.touches[1];

                    // Calculate center of pinch
                    const pinchCenterX = (touch1.clientX + touch2.clientX) / 2;
                    const rect = canvas.getBoundingClientRect();
                    const centerX = pinchCenterX - rect.left - canvas.width / 2;

                    // Calculate new scale based on pinch distance
                    const currentDistance = Math.abs(
                        touch1.clientX - touch2.clientX,
                    );

                    if (lastPinchDistance) {
                        const scaleChange = currentDistance / lastPinchDistance;
                        const oldScale = scale;
                        scale *= scaleChange;
                        scale = Math.min(Math.max(minZoom, scale), maxZoom);

                        // Adjust offset to zoom towards pinch center
                        const centerFreq = screenXToMhz(pinchCenterX);
                        offset.x = pinchCenterX - mhzToScreenX(centerFreq);
                    }

                    lastPinchDistance = currentDistance;
                } else if (e.touches.length === 1 && isDragging) {
                    offset.x += e.touches[0].clientX - lastPosition.x;
                    lastPosition.x = e.touches[0].clientX;
                }
            });

            canvas.addEventListener("touchend", () => {
                isDragging = false;
                lastPinchDistance = null;
            });

            // Mouse wheel zooming
            canvas.addEventListener("wheel", (e) => {
                e.preventDefault();

                const currentTime = Date.now();

                // Reset direction lock if enough time has passed
                if (currentTime - lastWheelTime > wheelTimeout) {
                    scrollDirection = null;
                }
                lastWheelTime = currentTime;

                // Determine scroll direction if not already locked
                if (!scrollDirection) {
                    if (
                        Math.abs(e.deltaX) >
                        Math.abs(e.deltaY) * scrollThreshold
                    ) {
                        scrollDirection = "horizontal";
                    } else if (
                        Math.abs(e.deltaY) >
                        Math.abs(e.deltaX) * scrollThreshold
                    ) {
                        scrollDirection = "vertical";
                    } else {
                        // If no clear direction yet, exit early
                        return;
                    }
                }

                // Handle scrolling based on locked direction
                if (scrollDirection === "vertical") {
                    // Zoom logic
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const centerFreq = screenXToMhz(mouseX);

                    // Sensitivity settings
                    const zoomFactor = e.deltaY > 0 ? 0.96 : 1.04;
                    scale = Math.min(
                        Math.max(minZoom, scale * zoomFactor),
                        maxZoom,
                    );

                    const newMouseX = mhzToScreenX(centerFreq);
                    offset.x += mouseX - newMouseX;
                } else if (scrollDirection === "horizontal") {
                    // Pan logic
                    offset.x -= e.deltaX;
                }

                // For scale tier tuning purposes
                if (scale !== lastScale) {
                    const tier = getZoomTier(scale);
                    const tierName = Object.keys(zoomTiers).find(
                        (key) => zoomTiers[key] === tier,
                    );
                    console.log(
                        `Scale: ${scale.toFixed(2)}, Tier: ${tierName}`,
                        tier,
                    );
                    lastScale = scale;
                }
            });

            // Zoom buttons
            document.getElementById("zoom-in").addEventListener("click", () => {
                const centerFreq = screenXToMhz(canvas.width / 2);
                const oldScale = scale;
                scale *= 1.2;
                scale = Math.min(Math.max(minZoom, scale), maxZoom);
                const newCenterX = mhzToScreenX(centerFreq);
                offset.x += canvas.width / 2 - newCenterX;
            });

            document
                .getElementById("zoom-minus")
                .addEventListener("click", () => {
                    const centerFreq = screenXToMhz(canvas.width / 2);
                    const oldScale = scale;
                    scale *= 0.8;
                    scale = Math.min(Math.max(minZoom, scale), maxZoom);
                    const newCenterX = mhzToScreenX(centerFreq);
                    offset.x += canvas.width / 2 - newCenterX;
                });

            // Wi-Fi Checkboxes

            document
                .getElementById("show-wifi")
                .addEventListener("change", (e) => {
                    showWifi = e.target.checked;
                });

            document
                .getElementById("show-channels")
                .addEventListener("change", (e) => {
                    showWifiChannels = e.target.checked;
                });

            document
                .getElementById("show-frequencies")
                .addEventListener("change", (e) => {
                    showWifiFrequencies = e.target.checked;
                });

            document
                .getElementById("show-overlapping")
                .addEventListener("change", (e) => {
                    showOverlapping = e.target.checked;
                });

            // Bluetooth checkboxes

            document
                .getElementById("show-bluetooth")
                .addEventListener("change", (e) => {
                    showBluetooth = e.target.checked;
                });

            document
                .getElementById("show-bluetooth-channels")
                .addEventListener("change", (e) => {
                    showBluetoothChannels = e.target.checked;
                });

            document
                .getElementById("show-bluetooth-frequencies")
                .addEventListener("change", (e) => {
                    showBluetoothFrequencies = e.target.checked;
                });

            // Zigbee checkboxes

            document
                .getElementById("show-zigbee")
                .addEventListener("change", (e) => {
                    showZigbee = e.target.checked;
                });

            document
                .getElementById("show-zigbee-channels")
                .addEventListener("change", (e) => {
                    showZigbeeChannels = e.target.checked;
                });

            document
                .getElementById("show-zigbee-frequencies")
                .addEventListener("change", (e) => {
                    showZigbeeFrequencies = e.target.checked;
                });

            // General
            document
                .getElementById("show-band-labels")
                .addEventListener("change", (e) => {
                    showBandLabels = e.target.checked;
                });

            document
                .getElementById("show-subbands")
                .addEventListener("change", (e) => {
                    showSubbands = e.target.checked;
                });

            document
                .querySelectorAll('input[name="domain"]')
                .forEach((radio) => {
                    radio.addEventListener("change", (e) => {
                        selectedDomain = e.target.value;
                    });
                });

            heightSlider.addEventListener("input", (e) => {
                chartSettings.channelHeight = parseInt(e.target.value);
            });

            // Helper functions for coordinate conversion
            function mhzToScreenX(mhz) {
                const pixelsPerMhz = 2 * scale;
                return mhz * pixelsPerMhz + offset.x;
            }

            function screenXToMhz(screenX) {
                const pixelsPerMhz = 2 * scale;
                const freq = (screenX - offset.x) / pixelsPerMhz;
                return Math.max(0, Math.min(8000, freq));
            }

            function drawLabel(x, baselineY, text, row, color) {
                const y = baselineY + BASE_LABEL_OFFSET + row * LABEL_SPACING;
                ctx.fillStyle = color;
                ctx.fillText(text, x, y);
            }

            // Start the animation
            draw();
        </script>
    </body>
</html>
